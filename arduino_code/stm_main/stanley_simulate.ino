#ifdef STANLEY_SIMULATION

#include "src/Stanley.h"

// Create stanley object
Stanley stanley;
Pose robot;

// Create path
PathData path;
//float cx[] = {0,0.472004201583071,0.492962246335810,-0.159539246690626,-1.34737982749741,-2.59596148419736,-3.27224668237026,-2.85261348944282,-1.17666612525992,1.41831092731613};
//float cy[] = {0,0.293008547651036,0.995769112255507,1.65901326291961,1.76715568227344,0.988449976114071,-0.635226542918285,-2.64311427486068,-4.28585385301679,-4.79462137331569};
//int N = 10;
float cx[] = {0.0482962941761171,0.0965925883522343,0.131947950866196,0.144888956520708,0.160616244473060,0.179076598649051,0.200207555159130,0.223937613656065,0.250186479269084,0.278865334295833,0.309877138732866,0.343116958627742,0.374128763064776,0.402807618091525,0.429056483704543,0.452786542201479,0.488141904715440,0.532151984186345,0.581119017013611,0.630928752239414,0.679895785066681,0.723905864537585,0.759261227051547,0.782991285548482,0.806721344045418,0.830451402542354,0.854181461039289,0.877911519536225,0.901641578033161,0.925371636530096,0.949101695027032,0.972831753523968,0.993962710034046,1.01242306421004,1.02815035216239,1.04109135781690,1.04833801034385,1.04979231136469,1.04543459398613,1.03532378876068,1.02521298353523,1.01510217830978,1.00499137308434,0.994880567858886,0.979153405851574,0.958022569589971,0.931773816902711,0.900762116541594,0.872083370199560,0.845834617512300,0.822104675800062,0.800973839538459,0.779843003276856,0.758712167015253,0.737581330753650,0.716450494492047,0.695319658230444,0.674188821968841,0.653057985707238,0.631927149445635,0.610796313184032,0.589665476922429,0.568534640660826,0.547403804399223,0.531676642391911,0.521565837166462,0.517208119787903,0.518662420808743,0.523020270361908,0.530266922888857,0.540377858052725,0.553318863707238,0.571779217883229,0.595509276380164,0.624188131406914,0.657427951301790,0.688439755738823,0.717118610765572,0.743367476378590,0.767097534875526,0.795776389902275,0.829016209797150,0.866367483776965,0.907325100788987,0.936003955815736,0.948944961470248,0.944587244091688,0.923456407830084,0.910515530334125,0.906157812955565,0.910515662508729,0.923456668163241,0.941917022339231,0.965647080836167,0.994325935862915,1.02756575575779,1.05624461078454,1.07997466928147,1.09843502345747,1.11137602911198,1.13762489472499,1.17497616870481,1.22029156584452,1.26976364866382,1.31923573148312,1.36870781430243,1.41817989712173,1.46765197994103,1.51594827411714,1.56241565622496,1.60642573569586,1.64738335270788,1.68993919858361,1.73394927805451,1.77926467519422,1.82573205730204,1.87469909012930,1.92467793766914,1.97415002048844,2.02161215691774,2.06907429334704,2.11653642977634,2.16399856620564,2.21146070263494,2.25892283906423,2.30638497549353,2.35384711192283,2.40130924835213,2.44662464549184,2.48918049136757,2.52840129213880,2.56375665465276,2.59699647454764,2.62800827898467,2.65668713401142,2.68293599962444,2.70139635380043,2.71150728896430,2.71296158998514,2.70571506873681,2.70135735135825,2.69990318296077,2.70135748398161,2.70571533353477,2.71007318308794,2.71443103264110,2.71878888219427,2.72314673174743,2.72460103276828,2.72314686437080,2.71878914699224,2.71154262574390,2.70143182051845,2.68849094302249,2.67276378101518,2.65430355014456,2.63317271388296,2.60944277217072,2.58319401948346,2.55451527314143,2.52826652045417,2.50453657874193,2.48340574248033,2.46494551160971,2.44921834960240,2.43627747210644,2.42616666688099,2.41892014563266,2.41167362438432,2.40442710313599,2.39718058188765,2.38993406063932,2.38268753939099,2.37544101814265,2.36819449689432,2.36094797564598,2.35949380724850,2.36385165680167,2.37396259196554,2.38968987991789};
float cy[] = {-0.0129409415752469,-6.93889390390723e-18,0.0353553156046779,0.0836515926107773,0.131113708173232,0.177581065787981,0.222896434891290,0.266906482877313,0.309462293926213,0.350419872887313,0.389640632512277,0.426991862389701,0.466212622014665,0.507170200975764,0.549726012024665,0.593736060010687,0.629091375615365,0.652821375719973,0.662932245914640,0.658574462448774,0.668685332643441,0.692415332748049,0.727770648352726,0.771780696338749,0.815790744324772,0.859800792310794,0.903810840296817,0.947820888282839,0.991830936268862,1.03584098425489,1.07985103224091,1.12386108022693,1.16917644933024,1.21564380694499,1.26310592250744,1.31140219951354,1.36087427271807,1.41085311832839,1.46066285933604,1.50962990557831,1.55859695182058,1.60756399806286,1.65653104430513,1.70549809054741,1.75296024784346,1.79827567301951,1.84083155372198,1.88005239563941,1.92101005070228,1.96356593140476,2.00757604236046,2.05289146753651,2.09820689271255,2.14352231788859,2.18883774306463,2.23415316824067,2.27946859341671,2.32478401859275,2.37009944376879,2.41541486894483,2.46073029412087,2.50604571929691,2.55136114447295,2.59667656964899,2.64413872694505,2.69310577318732,2.74291551419497,2.79289435980529,2.84270408924917,2.89217616245369,2.94114318186586,2.98943945887196,3.03590681648671,3.07991686447273,3.12087444343383,3.15822567331126,3.19744643293622,3.23840401189732,3.28095982294622,3.32496987093225,3.36592744989334,3.40327867977077,3.43651845010820,3.46519725079261,3.50615482975371,3.55445110675981,3.60426084776746,3.64957627294350,3.69787258428955,3.74768232529719,3.79749205474107,3.84578833174716,3.89225568936191,3.93626573734794,3.97722331630904,4.01457454618646,4.05553212514756,4.09954217313358,4.14600953074833,4.19430580775443,4.23686161880333,4.27010138914076,4.29123228552662,4.29847887241427,4.30572545930192,4.31297204618957,4.32021863307722,4.32746521996487,4.34040616154011,4.35886645406344,4.38259645416804,4.41127525485246,4.43752406400262,4.46125406410723,4.48238496049309,4.50084525301641,4.51095612321108,4.51241035792024,4.50516377103259,4.48943654605275,4.47370932107290,4.45798209609306,4.44225487111321,4.42652764613337,4.41080042115352,4.39507319617368,4.37934597119383,4.36361874621398,4.34248784982813,4.31623904067796,4.28522728827886,4.24987197267418,4.21252074279676,4.17329998317180,4.13234240421070,4.08978659316180,4.04331923554705,3.99435221613488,3.94437337052455,3.89490127809056,3.84509153708291,3.79511268761364,3.74513384200332,3.69532411255944,3.64551438311557,3.59570465367170,3.54589492422782,3.49608519478395,3.44610634917362,3.39612749970435,3.34631775869671,3.29684566626272,3.24787862002044,3.19958230867439,3.15212015137833,3.10565274477754,3.06033731960150,3.01632720864579,2.97377132794332,2.93281367288045,2.89025779217797,2.84624768122226,2.80093225604622,2.75446484944543,2.70700269214937,2.65870638080332,2.60973933456105,2.56026724212705,2.51079514969306,2.46132305725907,2.41185096482508,2.36237887239109,2.31290677995710,2.26343468752310,2.21396259508911,2.16449050265512,2.11451165318585,2.06470192374198,2.01573490432981,1.96827278876735};
int N = 180;

// Sample time
float dt = 0.1;
float w;
float Kw = 1;
float v_max = 0.8;

void setup() {
  // Copy path data points
  memcpy(&path.cx, &cx, sizeof(float)*N);
  memcpy(&path.cy, &cy, sizeof(float)*N);
  path.N = N;

  Serial.begin(115200);
  Serial.println("waiting");
  while(!Serial.available());
  Serial.read();
  Serial.println("starting");
  stanley.setPath(path);

  // Initialise robot
//  robot.x = 0;
//  robot.y = 1.5;
//  robot.yaw = PI/2;
  robot.v = 0.8;
}

void loop() {
////  while(!Serial.available());
////  Serial.read();
//  printData();
  
  // Run stanley controller
  w = Kw * stanley.control(robot);

  // Calc speed
  robot.v = (1 - abs(w/PI)) * v_max;
  
  // Run process model
  runProcessModel();

  // Print data
  printData();
}

void runProcessModel() {
  robot.x += dt * robot.v * cos(robot.yaw);
  robot.y += dt * robot.v * sin(robot.yaw);
  robot.yaw += w*dt;
}

void printData() {
  Serial.print(robot.x, 5); Serial.print(", ");
  Serial.print(robot.y, 5); Serial.print(", ");
  Serial.print(robot.yaw, 5); Serial.println();
}

#endif
